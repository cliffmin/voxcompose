name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  actions: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.sha.outputs.sha256 }}
      jar_name: ${{ steps.sha.outputs.jar_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Build fat jar
        run: ./gradlew --no-daemon clean fatJar

      - name: Rename JAR with version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mv build/libs/voxcompose-*-all.jar build/libs/voxcompose-${VERSION#v}-all.jar
          ls -la build/libs/

      - name: Compute sha256
        id: sha
        shell: bash
        run: |
          FILE=$(ls build/libs/voxcompose-*-all.jar | head -n1)
          BASENAME=$(basename "$FILE")
          echo "jar=$FILE" >> "$GITHUB_OUTPUT"
          echo "jar_name=$BASENAME" >> "$GITHUB_OUTPUT"
          echo "sha256=$(shasum -a 256 "$FILE" | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "## Release ${VERSION}" > release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“¦ Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### Homebrew" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "brew tap cliffmin/tap" >> release_notes.md
          echo "brew install voxcompose" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### Direct Download" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "curl -L https://github.com/cliffmin/voxcompose/releases/download/${VERSION}/voxcompose-${VERSION#v}-all.jar -o voxcompose.jar" >> release_notes.md
          echo "java -jar voxcompose.jar --help" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“ Checksums" >> release_notes.md
          echo "" >> release_notes.md
          echo "**SHA256:** \`${{ steps.sha.outputs.sha256 }}\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ”„ What's Changed" >> release_notes.md
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> release_notes.md || echo "- Initial release" >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.sha.outputs.jar }}
          body_path: release_notes.md
          generate_release_notes: true
          draft: false
          prerelease: false

  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: release
    
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: cliffmin/homebrew-tap
          token: ${{ secrets.GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cd homebrew-tap
          VERSION=${{ needs.release.outputs.version }}
          VERSION_NUM=${VERSION#v}
          SHA256=${{ needs.release.outputs.sha256 }}
          
          # Update the formula
          sed -i "s|url \".*\"|url \"https://github.com/cliffmin/voxcompose/releases/download/${VERSION}/voxcompose-${VERSION_NUM}-all.jar\"|" Formula/voxcompose.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/voxcompose.rb
          sed -i "s|version \".*\"|version \"${VERSION_NUM}\"|" Formula/voxcompose.rb
          sed -i "s|libexec.install \"voxcompose-.*-all.jar\"|libexec.install \"voxcompose-${VERSION_NUM}-all.jar\"|" Formula/voxcompose.rb
          
          cat Formula/voxcompose.rb

      - name: Commit and push formula update
        run: |
          cd homebrew-tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/voxcompose.rb
          git commit -m "Update VoxCompose to ${{ needs.release.outputs.version }}" || exit 0
          git push || exit 0

